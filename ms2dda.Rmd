---
title: "Processing DDA MS^2^ data - Basic Functions"
author: "Michael Witting"
date: "24th of June 2018"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Basic processing of DDA MS^2^ data with XCMS

Metabolite identification is usually achieved by comparing MS2 spectra against reference spectra. Such MS2 data can be generated using data dependent acquistion. For further processing it is important to link the MS^1^ features and collected MS^2^ spectra. Here simply means to isolate MS2 spectra belonging to a certain chromatographic peak are presented.

## Setup of XCMS

XCMS3 is able to use multiple cores (e.g. when working on multiple files). If required a parallel backend can be registered.
```{r, message=FALSE, warning=FALSE}
#load required library
library(xcms)
library(ggplot2)

#set number of cores
noOfCores <- 4

## Use socket based parallel processing on Windows systems
if (.Platform$OS.type == "unix") {
  register(bpstart(MulticoreParam(noOfCores)))
} else {
  register(bpstart(SnowParam(noOfCores)))
}
```

## Read MS data

The example file contains an RP-LC-MS run of Mix 1 taken from the Agilent Pesticide Reference mix measured on a Sciex TripleTof 6600. First we plot a base peak chromatogram to get an overview on the chromatogram.
```{r}
## MS1 and MS2 data and file has to be read only once.
xrms <- readMSData("data\\PestMix1_DDA.mzML", mode = "onDisk", centroided = TRUE)

#plot BPC
bpis <- chromatogram(xrms, aggregationFun = "max")
plot(bpis)
```

## Detect peaks

Chromatographic peak detection is performed using the CentWave algorithm. Since only a single sample is analyzed no retention time alignment is required. Peak detection is performed only on the MS^1^ level.

```{r}
#set parameters and find chromatographic peaks
ms1cwp <- CentWaveParam(snthresh = 5, noise = 100, ppm = 10, peakwidth = c(3,30))
ms1data <- findChromPeaks(xrms, param = ms1cwp, msLevel = 1)

#get all peaks
chromPeaks <- chromPeaks(ms1data)

#check detected peaks
ggplot(as.data.frame(chromPeaks), aes(xmin = rtmin, xmax = rtmax, ymin = mzmin, ymax = mzmax)) +
  geom_rect(colour = "blue") +
  theme_bw()

```

## Get DDA MS2 spectra in file

All MS2 spectra can be extracted by filtering out the MS2 level and retrieve all spectra. A list of Spectrum2 objects is returned.

```{r}
#get all MS2 spectra from DDA experiment
ms2spectra <- spectra(filterMsLevel(xrms, msLevel = 2))
```


## Function to isolate specific

MS2 spectra corresponding to a specific peak can be isolated by comparing the retention time of the peak with the acquisition timing of the MS2 spectrum. Additionally, the precursor m/z and peak m/z should match.

```{r consolidation}
#function for DDA data
#MS2 spectra need to be list of spectrum2 objects
getDdaMS2Scans <- function(chromPeak, ms2spectra, mzTol = 0.01, rtTol = 30) {
  
  #make a new list
  filteredMs2spectra <- list()
  
  #isolate only the ones within range
  for(i in 1:length(ms2spectra)) {
    
    #isolate Ms2 spectrum
    ms2spectrum <- ms2spectra[[i]]
    
    #check if within range of peak
    if(abs(chromPeak[4] - ms2spectrum@rt) < rtTol & abs(chromPeak[1] - ms2spectrum@precursorMz) < mzTol) {
      filteredMs2spectra <- c(filteredMs2spectra, ms2spectrum)
    }
  }
  
  #return list with filtered ms2 spectra
  return(filteredMs2spectra)
}

```

## Example Peak: Fluopicolide

Fluopicolide is used as example. An EIC for the [M+H]+ is generated using the chromatogram function. The function from above is used to isolate MS2 spectra that are belonging to Fluopicolide. For each MS2 a vertical red line is added to the plot to illustrate the timing of MS2 data collection.

```{r}
#isolate Fluopicolide
chromPeak <- chromPeaks[57,]

#Fluopicolide, exact mass = 381.965430576, [M+H]+ = 382.972706
eic <- chromatogram(xrms, aggregationFun = "max", mz = c(382.96, 382.98), rt = c(430,450))
plot(eic)

#filter out fitting spectra
filteredMs2spectra <- getDdaMS2Scans(chromPeak, ms2spectra)

#mark position in EIC
abline(v = unlist(lapply(filteredMs2spectra, function(x) {return(x@rt)})), col = "red")
```

One example MS^2^ is plotted.

```{r}
#plot on example
plot(filteredMs2spectra[[4]]@mz, filteredMs2spectra[[4]]@intensity / max(filteredMs2spectra[[4]]@intensity) *100, type = "h", xlim = c(50, 400), xlab = "m/z", ylab = "rel. Int.")
```

